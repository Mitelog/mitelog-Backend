name: Deploy Backend (Auto Cleanup)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ JDK 17 설정
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3️⃣ Gradle 빌드
      - name: Build with Gradle
        run: chmod +x gradlew && ./gradlew clean build -x test

      # 4️⃣ Docker 이미지 빌드
      - name: Build Docker image
        run: docker build -t backend-app .

      # 5️⃣ Docker 이미지 tar 압축
      - name: Save Docker image
        run: docker save backend-app:latest | gzip > backend-app.tar.gz

      # 6️⃣ EC2로 전송
      - name: Copy Docker image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "backend-app.tar.gz"
          target: "/home/ubuntu/"

      # 7️⃣ EC2에서 배포 + 자동 정리
      - name: Deploy and Cleanup on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "🚀 Starting deployment on EC2..."

            # 1️⃣ 기존 컨테이너 종료
            docker stop backend-app || true
            docker rm backend-app || true

            # 2️⃣ 캐시 정리
            docker image prune -a -f
            docker builder prune -a -f

            # 3️⃣ Docker 이미지 로드
            docker load < ~/backend-app.tar.gz

            # 4️⃣ 새 컨테이너 실행 (따옴표 ❌)
            docker run -d -p 8080:8080 \
              -e DB_URL=${{ secrets.DB_URL }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              --name backend-app backend-app:latest

            echo "✅ Deployment done!"

            # 5️⃣ 자동 정리
            echo "🧹 Cleaning up EC2..."
            rm -f ~/backend-app.tar.gz
            sudo apt-get clean -y
            sudo apt-get autoremove -y
            docker system prune -a -f

            echo "✨ Cleanup complete. Checking disk usage..."
            df -h | grep '/$'
