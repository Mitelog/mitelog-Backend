name: Deploy Backend (Auto Cleanup)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3ï¸âƒ£ Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: chmod +x gradlew && ./gradlew clean build -x test

      # 4ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: docker build -t backend-app .

      # 5ï¸âƒ£ Docker ì´ë¯¸ì§€ tar ì••ì¶•
      - name: Save Docker image
        run: docker save backend-app:latest | gzip > backend-app.tar.gz

      # 6ï¸âƒ£ EC2ë¡œ ì „ì†¡
      - name: Copy Docker image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "backend-app.tar.gz"
          target: "/home/ubuntu/"

      # 7ï¸âƒ£ EC2ì—ì„œ ë°°í¬ + ìë™ ì •ë¦¬
      - name: Deploy and Cleanup on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸš€ Starting deployment on EC2..."

            # 1ï¸âƒ£ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
            docker stop backend-app || true
            docker rm backend-app || true

            # 2ï¸âƒ£ ìºì‹œ ì •ë¦¬
            docker image prune -a -f
            docker builder prune -a -f

            # 3ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¡œë“œ
            docker load < ~/backend-app.tar.gz

            # 4ï¸âƒ£ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (ë”°ì˜´í‘œ âŒ)
            docker run -d -p 8080:8080 \
              -e DB_URL=${{ secrets.DB_URL }} \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              --name backend-app backend-app:latest

            echo "âœ… Deployment done!"

            # 5ï¸âƒ£ ìë™ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up EC2..."
            rm -f ~/backend-app.tar.gz
            sudo apt-get clean -y
            sudo apt-get autoremove -y
            docker system prune -a -f

            echo "âœ¨ Cleanup complete. Checking disk usage..."
            df -h | grep '/$'
